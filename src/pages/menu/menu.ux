<template>
	<div class="container">
		<!-- 1. å›ºå®šçš„é¡¶éƒ¨æ  -->
		<div class="header" onclick="back">
			<text class="time-display">{{ currentTime }}</text>
			<text class="title">â€¹ä¸»èœå•</text>
		</div>
		<!-- 2. ç‹¬ç«‹æ»šåŠ¨çš„å†…å®¹åŒºåŸŸ -->
		<scroll class="scroll-wrapper" scroll-y="true">
			<div class="search-box" onclick="goToSearch">
				<div class="box-icon-wrapper">
					<image class="box-item-icon" src="/common/icon/search.png"></image>
				</div>
				<text class="box-item-text">æœç´¢</text>
			</div>
			<div class="music-card" onclick="back">
				<!-- a. å·¦ä¾§å°é¢ -->
				<image class="card-cover" src="{{ songCoverUrl }}"></image>

				<div class="card-main">
					<text class="card-title">
						{{ songName || "æš‚æ— æ’­æ”¾" }}
					</text>
					<text class="card-subtitle">
						{{ songArtists || "ç‚¹å‡»å‰å¾€æ’­æ”¾å™¨é¡µ" }}
					</text>
					<!-- b. æ’­æ”¾è¿›åº¦æ¡ -->
					<div class="progress">
						<progress class="card-progress" percent="{{ progress }}"></progress>
						<div class="progress-text">
							<text class="card-time">{{ progressCurrentTime }}</text>
							<text class="card-time">{{ progressTotalTime }}</text>
						</div>
					</div>
				</div>
			</div>

			<div class="menu-columns-container">
				<!-- å·¦åˆ—å®¹å™¨ -->
				<div class="column">
					<!-- FIX: ç»Ÿä¸€è°ƒç”¨ handleMenuClickï¼Œå¹¶ä¼ å…¥ item æ•°æ® -->
					<block for="{{ leftColumnItems }}">
						<div class="menu-item" onclick="handleMenuClick($item)">
							<div class="icon-wrapper">
								<image class="item-icon" src="{{ $item.icon }}"></image>
							</div>
							<text class="item-text">{{ $item.text }}</text>
						</div>
					</block>
				</div>
				<!-- å³åˆ—å®¹å™¨ -->
				<div class="column">
					<!-- FIX: ç»Ÿä¸€è°ƒç”¨ handleMenuClickï¼Œå¹¶ä¼ å…¥ item æ•°æ® -->
					<block for="{{ rightColumnItems }}">
						<div class="menu-item" onclick="handleMenuClick($item)">
							<div class="icon-wrapper">
								<image class="item-icon" src="{{ $item.icon }}"></image>
							</div>
							<text class="item-text">{{ $item.text }}</text>
						</div>
					</block>
				</div>
			</div>
		</scroll>
	</div>
</template>

<script>
import router from "@system.router";
import prompt from "@system.prompt";
import app from "@system.app";

export default {
	private: {
		currentTime: "",
		timer: null,
		leftColumnItems: [
			{
				text: "æ’­æ”¾åˆ—è¡¨",
				handler: "goToList",
				icon: "/common/icon/playlist.png",
			},
			{
				text: "ç§äººFM",
				handler: "goToPersonalFM",
				icon: "/common/icon/fm.png",
			},
			{
				text: "æˆ‘çš„æ­Œå•",
				handler: "goToSongList",
				icon: "/common/icon/songlist.png",
			},
			{
				text: "åº”ç”¨è®¾ç½®",
				handler: "goToSettings",
				icon: "/common/icon/settings.png",
			},
		],
		rightColumnItems: [
			{
				text: "å·²ä¸‹è½½",
				handler: "goToDownloadList",
				icon: "/common/icon/downloaded.png",
			},

			{
				text: "æ¯æ—¥æ¨è",
				handler: "goToDailyRecommend",
				icon: "/common/icon/calendar.png",
			},
			{
				text: "æœ¬åœ°æ”¶è—",
				handler: "goToLike",
				icon: "/common/icon/star-filled.png",
			},
			{ text: "ä¸ªäººä¸­å¿ƒ", handler: "goToUser", icon: "/common/icon/user.png" },
		],
		pressedKey: "",
		pressedAnimKey: "",
		pressedAnim: "",
		scrollLock: false, // è¯­ä¹‰ï¼štrue = æœ€è¿‘æ»šåŠ¨è¿‡/æ­£åœ¨æ»šåŠ¨ï¼Œç¦æ­¢è·³è½¬
		_scrollUnlockTimer: null, // 300ms è§£é”ç”¨
		_scrollThrottleTimer: null, // 32ms èŠ‚æµç”¨
	},

	computed: {
		songCoverUrl() {
			// ğŸ”¥ å¼ºåˆ¶ä¾èµ–ä¸€ä¸ªä¸€å®šä¼šå˜åŒ–çš„å€¼ï¼ˆä½ è¿™è¾¹è¿›åº¦èƒ½åˆ·ï¼Œè¯´æ˜å®ƒèƒ½è§¦å‘é‡ç®—ï¼‰
			const _tick = this.$app.$def.player.playerState.playDuration;

			const coverUrl = this.$app.$def.player.currSong?.coverUrl;
			return coverUrl || "/common/icon/more_light.png";
		},

		songName() {
			const _tick = this.$app.$def.player.playerState.playDuration;

			const name = this.$app.$def.player.currSong?.name;
			return name || "æš‚æ— æ’­æ”¾";
		},

		songArtists() {
			const _tick = this.$app.$def.player.playerState.playDuration;

			const artists = this.$app.$def.player.currSong?.artists;
			return artists || "ç‚¹å‡»å‰å¾€æ’­æ”¾å™¨é¡µ";
		},

		progress() {
			const duration = this.$app.$def.player.currSong?.duration || 0;
			if (duration === 0) return 0;
			return (this.$app.$def.player.playerState.playDuration / duration) * 100;
		},
		progressCurrentTime() {
			const t = this.$app.$def.player.playerState.playDuration;
			return this.second2time(t);
		},
		progressTotalTime() {
			const duration = this.$app.$def.player.currSong?.duration || 0;
			return this.second2time(duration);
		},
	},

	async onInit() {
		this.updateTime();

		// â‘  å…ˆæŒ¡ï¼šä¸æ˜¯ä¸¥æ ¼ true ç›´æ¥ terminate
		if (this.$app.$def.isActivated !== true) {
			prompt.showToast({
				message: "éæ³•ç»•è¿‡ï¼ŒIPåŠè®¾å¤‡ä¿¡æ¯å·²ä¸Šä¼ ï¼",
				duration: 3000,
			});
			app.terminate();
			return;
		}

		// â‘¡ å¼ºåˆ¶å†è·‘ä¸€æ¬¡æ¿€æ´»éªŒè¯ï¼ˆé˜²ä¸­é—´é¡µæ’å…¥/æ”¹flagï¼‰
		//    å¿…é¡» awaitï¼Œç¡®ä¿é¡ºåº
		const ok = await this.$app.$def.runActivationFlow();

		// â‘¢ å†æŒ¡ï¼šä»¥ runActivationFlow çš„ç»“æœ + isActivated åŒé‡åˆ¤æ–­
		//    ï¼ˆä½  flow é‡Œå·²ç»ä¼šå†™ isActivatedï¼Œè¿™é‡ŒåŒåˆ¤æ›´ç¡¬ï¼‰
		if (ok !== true || this.$app.$def.isActivated !== true) {
			prompt.showToast({
				message: "éæ³•ç»•è¿‡ï¼ŒIPåŠè®¾å¤‡ä¿¡æ¯å·²ä¸Šä¼ ï¼",
				duration: 3000,
			});
			app.terminate();
			return;
		}
		this.timer = setInterval(() => {
			this.updateTime();
		}, 1000);
	},

	onDestroy() {
		if (this.timer) {
			clearInterval(this.timer);
		}
	},

	/**
	 * FIX: æ–°å¢ç»Ÿä¸€çš„èœå•é¡¹ç‚¹å‡»å¤„ç†å‡½æ•°
	 * @param {object} item - è¢«ç‚¹å‡»çš„èœå•é¡¹çš„æ•°æ®å¯¹è±¡
	 */
	handleMenuClick(item) {
		if (item && typeof this[item.handler] === "function") {
			this[item.handler]();
		} else {
			console.error(`æœªæ‰¾åˆ°åä¸º ${item.handler} çš„å¤„ç†å‡½æ•°ã€‚`);
		}
	},

	updateTime() {
		const now = new Date();
		const hours = now.getHours().toString().padStart(2, "0");
		const minutes = now.getMinutes().toString().padStart(2, "0");
		this.currentTime = `${hours}:${minutes}`;
	},

	second2time(second) {
		const minutes = Math.floor(second / 60);
		const seconds = Math.floor(second % 60);
		return `${minutes}:${seconds.toString().padStart(2, "0")}`;
	},
	back() {
		router.back();
	},
	goToPlayer() {
		router.push({ uri: "/pages/player" });
	},
	goToList() {
		router.push({ uri: "/pages/list", params: { listType: "playlist" } });
	},
	goToSearch() {
		router.push({ uri: "/pages/search" });
	},
	goToDownloadList() {
		router.push({ uri: "/pages/list", params: { listType: "downloadlist" } });
	},
	goToLike() {
		router.push({ uri: "/pages/list", params: { listType: "favorites" } });
	},
	goToPersonalFM() {
		router.push({ uri: "/pages/list", params: { listType: "personal_fm" } });
	},
	goToDailyRecommend() {
		router.push({
			uri: "/pages/list",
			params: { listType: "daily_recommend" },
		});
	},
	goToSongList() {
		router.push({ uri: "/pages/songlist_list" });
	},
	goToStorage() {
		router.push({ uri: "/pages/storage" });
	},
	goToSettings() {
		router.push({ uri: "/pages/settings" });
	},
	goToUser() {
		router.push({ uri: "/pages/user" });
	},
};
</script>

<style>
/* æ ·å¼éƒ¨åˆ†å®Œå…¨ä¸å˜ */
.container {
	width: 100%;
	flex-direction: column;
	align-items: center;
	background-color: black;
}
.header {
	width: 100%;
	height: 90px;
	flex-direction: column;
	justify-content: center;
	align-items: center;
	flex-shrink: 0;
}
.time-display {
	font-size: 28px;
	font-weight: bold;
	color: #ffffff;
	padding-top: 5px;
	text-align: center;
}
.title {
	font-size: 32px;
	padding: 5px;
	text-align: center;
	font-weight: bold;
	color: #fff;
}
.scroll-wrapper {
	width: 100%;
	height: 376px;
	flex-direction: column;
	align-items: center;
}
.search-box {
	width: 160px;
	height: 64px;
	padding: 12px 12px;
	border-radius: 32px;
	margin-bottom: 10px;
	background-color: #2e323c;
	flex-direction: row;
	align-items: center;
	justify-content: space-between;
}
.box-icon-wrapper {
	padding: 4px 5px 6px 5px;
	border-radius: 30px;
	background-color: rgba(136, 136, 136, 0.2);
}
.box-item-icon {
	width: 32px;
	height: 32px;
}
.box-item-text {
	padding-right: 22px;
	font-size: 26px;
	font-weight: bold;
	color: #ffffff;
}
/* éŸ³ä¹èƒ¶å›Šæœ¬ä½“ï¼šå¿…é¡»æ˜ç¡®å°ºå¯¸/èƒŒæ™¯ï¼Œå¦åˆ™å¾ˆå®¹æ˜“â€œçœ‹ä¸åˆ°â€ */
.music-card {
	width: 370px;
	height: 140px;
	padding: 28px 22px;
	margin-bottom: 10px;
	flex-direction: row;
	align-items: center;
	justify-content: flex-start;

	background-color: #2e323c;
	border-radius: 36px; /* èƒ¶å›Šåœ†è§’ */
}

/* å·¦ä¾§å°é¢ */
.card-cover {
	width: 96px;
	height: 96px;
	margin-right: 16px;
	border-radius: 18px;
	background-color: rgba(255, 255, 255, 0.06);
}

/* å³ä¾§ç«–æ’ï¼ˆå¿…è¦å±‚ï¼‰ */
.card-main {
	flex: 1;
	flex-direction: column;
	justify-content: space-around;
}

/* æ­Œå */
.card-title {
	font-size: 28px;
	font-weight: bold;
	color: rgba(255, 255, 255, 0.96);

	lines: 1;
	text-overflow: ellipsis;
}

/* æ­Œæ‰‹ */
.card-subtitle {
	margin-top: 2px;
	font-size: 22px;
	font-weight: bold;
	color: rgba(255, 255, 255, 0.62);

	lines: 1;
	text-overflow: ellipsis;
}
.progress {
	flex-direction: column;
	align-items: center;
	justify-content: space-between;
}
/* è¿›åº¦æ¡ï¼šåªç”¨ progress æ”¯æŒçš„æ ·å¼é¡¹ */
.card-progress {
	margin-top: 8px;
	stroke-width: 12px;
	color: #bac3ff;
	background-color: rgba(136, 136, 136, 0.2);
}
.progress-text {
	width: 100%;
	flex-direction: row;
	justify-content: space-between;
	margin-top: 4px;
}
/* å³ä¾§æ—¶é—´ */
.card-time {
	font-size: 18px;
	font-weight: bold;
	color: rgba(255, 255, 255, 0.55);
	text-align: right;

	lines: 1;
}

.menu-columns-container {
	width: 380px;
	flex-direction: row;
	justify-content: space-around;
	padding-bottom: 80px;
}
.column {
	flex-direction: column;
}
.menu-item {
	width: 180px;
	height: 140px;
	background-color: #2e323c;
	margin-bottom: 10px;
	border-radius: 36px;
	flex-direction: column;
	justify-content: center;
	align-items: center;
}
.icon-wrapper {
	padding: 4px 5px 6px 5px;
	border-radius: 30px;
	background-color: rgba(136, 136, 136, 0.2);
	margin-bottom: 8px;
}
.item-icon {
	width: 50px;
	height: 50px;
}
.item-text {
	font-size: 28px;
	font-weight: bold;
	color: #ffffff;
}

@media screen and (shape: rect) {
	.header {
		padding-top: 10px;
		height: 65px;
		flex-direction: row-reverse;
		justify-content: space-around;
	}
	.time-display {
		font-size: 32px;
		padding-top: 0px;
	}
	.scroll-wrapper {
		height: 449px;
	}
	.menu-columns-container {
		padding-bottom: 10px;
	}
}
</style>
